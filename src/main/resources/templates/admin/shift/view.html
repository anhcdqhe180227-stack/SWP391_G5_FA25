<!DOCTYPE html>
<html lang="en" th:fragment="layout" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8"/>
    <title>Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

</head>
<body>

<th:block th:replace="layout/admin-layout :: layout">
    <th:block th:fragment="pageContent">
        <div class="pd-ltr-20 xs-pd-20-10">
            <div class="min-height-200px">
                <div class="page-header">
                    <div class="row">
                        <div class="col-md-6 col-sm-12">
                            <div class="title">
                                <h4>Quản lý ca làm</h4>
                            </div>
                            <nav aria-label="breadcrumb" role="navigation">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item">
                                        <a th:href="@{/admin/dashboard}">Quản trị</a>
                                    </li>
                                    <li class="breadcrumb-item active" aria-current="page">
                                        Quản lý ca làm
                                    </li>
                                </ol>
                            </nav>
                        </div>

                    </div>
                </div>

                <div th:if="${param.add}" class="alert alert-success" role="alert">
                    Thêm thành công!
                </div>

                <div th:if="${param.update}" class="alert alert-success" role="alert">
                    Cập nhật thành công!
                </div>

                <!-- Simple Datatable start -->
                <div class="card-box mb-30">
                    <div class="pd-20">
                        <h4 class="text-blue h4">Quản lý ca làm</h4>
                    </div>
                    <div class="pb-20">
                        <div id="calendar"></div>
                    </div>
                </div>

                <div class="modal fade" id="shiftModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <form id="shiftForm" method="post" th:action="@{/admin/shift/save}">
                            <input type="hidden" name="id" id="shiftId"/>
                            <input type="hidden" name="date" id="shiftDate"/>

                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalTitle">Thêm ca làm</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label>Khung giờ</label>
                                        <select name="fixedTime" id="fixedTime" class="form-select" required>
                                            <option value="MORNING">Sáng (07:00 - 11:00)</option>
                                            <option value="AFTERNOON">Chiều (13:00 - 17:00)</option>
                                        </select>
                                    </div>


                                    <div class="mb-3">
                                        <label>Nhân viên</label>
                                        <select name="empId" id="empSelect" class="form-select">
                                            <option value="">-- Chọn nhân viên --</option>
                                            <option th:each="d : ${employees}" th:value="${d.id}"
                                                    th:text="${d.fullName}"></option>
                                        </select>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-danger" id="deleteBtn" style="display: none;">
                                        <i class="mdi mdi-delete"></i> Xóa
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                    <button type="submit" class="btn btn-primary">Lưu</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </th:block>
</th:block>


<script>
    $(document).ready(function() {
    if ($.fn.dataTable.isDataTable('.data-table')) {
        $('.data-table').DataTable().destroy();
    }

    $('.data-table').DataTable({
        responsive: true,
        autoWidth: false,
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const modal = new bootstrap.Modal(document.getElementById('shiftModal'));
        const deleteBtn = document.getElementById('deleteBtn');

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '/admin/shift/api',
            selectable: true,
            select: function(info) {
                openModal(null, info.startStr);
            },
            eventClick: function(info) {
                openModal(info.event);
            }
        });

        calendar.render();

        function openModal(event, selectedDate = null) {
            const form = document.getElementById('shiftForm');
            form.reset();

            if (event) {
                // Edit mode - hiện nút xóa
                document.getElementById('modalTitle').textContent = 'Chỉnh sửa ca trực';
                document.getElementById('shiftId').value = event.id;
                document.getElementById('shiftDate').value = event.start.toISOString();
                document.getElementById('fixedTime').value = event.extendedProps.fixedTime;
                document.getElementById('empSelect').value = event.extendedProps.empId || '';
                deleteBtn.style.display = 'inline-block';

                deleteBtn.onclick = function() {
                    if (confirm('Bạn có muốn xóa ca trực này không?')) {
                        deleteShift(event.id);
                    }
                };
            } else {
                document.getElementById('modalTitle').textContent = 'Thêm ca trực';
                document.getElementById('shiftId').value = '';
                document.getElementById('shiftDate').value = selectedDate;
                deleteBtn.style.display = 'none';
                deleteBtn.onclick = null;
            }

            modal.show();
        }

        function deleteShift(shiftId) {
            fetch('/admin/shift/api/delete/' + shiftId, {
                method: 'POST'
            })
            .then(() => {
                modal.hide();
                calendar.refetchEvents();
                alert('Xóa thành công!');
            })
            .catch(error => {
                alert('Lỗi khi xóa: ' + error);
            });
        }

        document.getElementById('shiftForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch('/admin/shift/api/save', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    return response.text().then(text => Promise.reject(text));
                }
            })
            .then(data => {
                modal.hide();
                calendar.refetchEvents();
                alert('Lưu thành công!');
            })
            .catch(error => {
                alert('Lỗi: ' + error);
            });
        });
    });
</script>

</body>
</html>